<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Burn Down Charts</title>

    <link href="bootstrap/prettify/prettify.css"
          type="text/css" rel="stylesheet" />
    <link href="bootstrap/css/bootstrap.min.css"
          type="text/css" rel="stylesheet" />
    <link href="bootstrap/css/bootstrap-responsive.min.css"
          type="text/css" rel="stylesheet" />
    <link href="bootstrap/css/style.css"
          type="text/css" rel="stylesheet" />
    <link href="css/style.css"
          type="text/css" rel="stylesheet" />
    <style type="text/css">
    html {
        height: 100%;
    }
    body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: calibri;
    }
    #container {
        padding: 50px 10px 40px;
        border: solid 1px #666;
        border-radius: 5px;
        background-color: #FFF;
    }
    </style>
</head>
<body style="background-color: #EEE;">
    <div class="navbar navbar-fixed-top">
        <div class="navbar-inner">
            <div class="container">
                <ul class="nav">
                    <li class="dropdown">
                        <a href="#" class="dropdown" data-toggle="dropdown">
                            Projects
                            <b class="caret"></b>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="#">Burn Down</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div id="container" class="container">
        <div class="chart">
        </div>
    </div>
    <script src="bootstrap/prettify//prettify.js"
            type="text/javascript" rel="javascript"></script>
    <script src="bootstrap/js/jquery-1.7.1.min.js"
            type="text/javascript" rel="javascript"></script>
    <script src="bootstrap/js/bootstrap.min.js"
            type="text/javascript" rel="javascript"></script>
    <script src="resources/d3.v2.js?2.8.0"
            type="text/javascript" rel="javascript"></script>
    <script type="text/javascript">
        var data;
        var fn;

        $.ajax({
            url: '/api/projects.json',
            dataType: 'jsonp',
            success: function(d) {
                data             = d
                new fillMenu(d)
            }
        })

        function fillMenu(data) {
            // Received Project list.  Populate dropdown-menu, and dispatch
            // initial default project data load.  Each project has an <a
            // href... /> with an id of "project-link"
            var items	= "";
            for (proj in data) {
                items += '<li><a id="' + proj + '-link" href="#">'
                    + data[proj].project + '</a></li>'
            }
            $('.dropdown-menu').html(items);
            for (proj in data) {
                $('#'+data[proj].project+'-link').live("click", function (){
                    $.ajax({
                        url: '/api/data/' + data[proj].project + '/elapsed.json',
                        dataType: 'jsonp',
                        success: function(d) {
                            data             = d
                            new drawGraph(d)
                        }
                    })
                })
            }
            // Get project json object from api and send it to drawGraph
            $.ajax({
                url: '/api/data/' + data[0].project + '/elapsed.json',
                dataType: 'jsonp',
                success: function(d) {
                    data             = d
                    new drawGraph(d)
                }
            })
        }

        // capitalizes to first letter in string
        String.prototype.capitalize = function() {
            return this.charAt(0).toUpperCase() + this.slice(1);
        }

        function drawGraph(data) {
            //   json object structure:
            //   {
            //       list:        Array,   # data array
            //       project:     String,  # project name
            //       style:       String,  # style is the type of graph
            //   }
            var allData          = data
            var data             = data.list

            // Width and Height for the svg element
            var w                = 1170                //document.body.offsetWidth
            var h                = 400                 //document.body.offsetHeight

            // Graph positioning variables
            var top              = 20 // top side offset
            var right            = 20 // right side offset
            var left             = 40 // left side offset
            var bottom           = 40 // bottom offset

            // Graph width and height relative to the svg
            // width and height and calculating offsets
            var gWidth           = w - left - right
            var gHeight          = h - bottom - top

            // x domain min and max
            var xMin             = 0
            var xMax             = []
            var lastLine         = 0
            // Create list for x axis rules and range
            for(i in data) {
                if(data[i].lines) {
                    lastLine     = i
                }
                xMax.push(data[i].label)
            }
            // y domain min and max
            var yMin = d3.min(data, function (d) {
                if(d.estimated) {
                    return -( d.estimated['deltaTotal#'] )
                } else {
                    return 0
                }
            })
            var yMax = d3.max(data, function (d) {
                var e            = d.estimated
                if(e) {
                    return (e['todoTotal#'] + e['doneTotal#'])
                } else {
                    return 0
                }
            })

            // if yMin is too small to create a negative rule line
            // then force a rule
            var yMin             = yMin > -(yMax/8) ? -(yMax/6) : yMin

            // define x and y scales
            var x = d3.scale.ordinal()
                .domain(xMax)
                // space between bars will be 65% of bar width
                .rangeBands([0, gWidth], 0.65)
            var y = d3.scale.linear()
                .domain([yMin, yMax])
                .range([gHeight, 0])

            // Create SVG element
            var svg = d3.select('.chart').append('svg')
                .attr('width', w)
                .attr('height', h)
                .attr('style', 'display: block; margin: 0 auto;')
            // Create x Axis rules
            var xAxis = svg.append('g')
                .attr('class', 'xAxis')
                .attr('transform', 'translate(' + left + ', ' + top + ')')

            // Assign data using y axis ticks function to .rule elements
            var xRule = xAxis.selectAll('.rule')
                .data(y.ticks(10))
            // Position container for rules
            .enter().append('g')
                .attr("transform", function(d) {
                    return 'translate(0,' + y(d) + ')';
                })
            // Draw line for rules
            xRule.append('line')
                .attr('x2', gWidth)
                .attr('style', 'stroke: #EEE; stroke-width: 1; stroke-opacity: 1;')
            function roundNumber(num, dec) {
                var result = Math.round(num*Math.pow(10,dec))/Math.pow(10,dec);
                if(result===0) {
                    result                = '0.0'
                }
                return result;
            }

            // Draw text for rules
            xRule.append("text")
                .attr("x", 6)
                .attr("dy", ".25em")
                .attr("transform", "translate(-10,0)")
                .attr('text-anchor', 'end')
                .attr('style', 'font-size: 10pt; fill: #BBB;')
            // Convert from seconds to hours
                .text(function(d) {
                    return ((roundNumber(d/3600,1)+'0').replace(/\./,':'))
                });

            // Create container for Graph
            var graph = svg.append('g')
                .attr('width', gWidth)
                .attr('height', gHeight)
                .attr('transform', 'translate(' + left + ','+top+')')

            var barData                   = []
            for(i in data) {
                if(data[i].estimated) {
                    barData[i]            = data[i]
                } else {
                    break
                }
            }

            // Assign data to the .bars element then create
            var bars = graph.selectAll('.bars')
                .data(barData, function (d) { return d.estimated['todo#'] })
            .enter().append('g')
            // Creating rectangles
            // - Green rect is estimations done
            // - Grey rect is estimations todo
            // - Red is estimations added
            // - Offset is Estimations removed

            // Create Grey rect
            var greyDelay                 = 20
            var greyDuration              = 300
            var greyY                     = []
            var greyH                     = []

            // Create Green rect
            var greenDelay                = 20
            var greenDuration             = 300
            var greenY                    = []
            var greenH                    = []

            // Create Red rect
            var redDelay                  = 20
            var redDuration               = 300
            var redY                      = []
            var redH                      = []

            bars.append('rect')
                .attr('class', 'bar')
                .attr('index', function (d, i) {
                    return i
                })
                .attr('width', x.rangeBand())
                .attr('height', function(d, i) {
                    var d                 = d.estimated
                    // Calculate Height:
                    // todoTotal - added and multiply by single range
                    // interval
                    var a                 = d['todoTotal#']
                    var b                 = d['added#']
                    var c                 = (a - b)
                    var r                 = y(0) - y(1)
                    greyH[i]              = (r*c)

                    // return 0 for transition start
                    return 0
                })
                .attr('x', function(d, i) {
                    return x(i)
                })
                .attr('y', function (d, i) {
                    var d                 = d.estimated
                    // Calculate range interval and multiply
                    // deltaTotal by it to get offset and then add to
                    // todoTotal
                    var a                 = d['deltaTotal#']
                    var b                 = d['todoTotal#']
                    var r                 = y(0) - y(1)
                    var t                 = (y(b) + (a*r))
                    greyY[i]              = t

                    // return greyY
                    return greyY[i]
                })
                .attr('style', 'fill: #DDD; fill-opacity: 0.8;')
                .transition().delay(function (d, i) {
                    // Animate in sequence left to right
                    return (i*greyDelay)
                }).duration(greyDuration)
                .attr('height', function (d,i) {
                    return greyH[i]
                })

            bars.append('rect')
                .attr('width', x.rangeBand())
                .attr('height', 0)
                .attr('x', function(d, i) {
                    return x(i)
                })
                .attr('y', function (d, i) {
                    var d                 = d.estimated
                    // Calculate range interval and multiply done by
                    // it to get offset and then subtract from greyY
                    var a                 = d['done#']
                    var r                 = y(0) - y(1)
                    var t                 = (a*r)
                    greenH[i]             = t
                    greenY[i]             = greyY[i] - t
                    return greyY[i]
                })
                .attr('style', 'fill: #060; fill-opacity: 0.4;')
                .transition().delay(function (d, i) {
                    // Start animation after Grey bar animation in
                    // sequence left to right every 20ms
                    return ((i*greenDelay) + (xMax.length*greyDelay + greyDuration))
                }).duration(greenDuration)
                .attr('height', function (d, i) {
                    return greenH[i]
                })
                .attr('y', function (d, i) {
                    return greenY[i]
                })


            bars.append('rect')
                .attr('width', x.rangeBand())
                .attr('height', function (d, i) {
                    var d                 = d.estimated
                    var a                 = d['added#']
                    var r                 = y(0) - y(1)
                    var t                 = (a*r)
                    redH[i]               = t

                    // return 0 for transition start
                    return 0
                })
                .attr('x', function(d, i) {
                    return x(i)
                })
                .attr('y', function (d, i) {
                    var d                 = d.estimated
                    // red y is grey's height + offset from top
                    var a                 = greyH[i] + greyY[i]
                    redY[i]               = a

                    // return redY
                    return redY[i]
                })
                .attr('style', 'fill: #A00; fill-opacity: 0.5;')
                .transition().delay(function (d, i) {
                    // Start animation after Grey bar animation in
                    // sequence left to right every 20ms
                    return i*redDelay + (xMax.length*greyDelay + greyDuration)
                }).duration(redDuration)
                .attr('height', function (d, i) {
                    return redH[i]
                })


            // Create container for x axis rules
            var yAxis = svg.append('g')
                .attr('class', 'xAxis')
                .attr('transform', 'translate('+left+', '+top+')')
            // Create and position container for rule
            var yRule = yAxis.selectAll('.rule')
                .data(data)
            .enter().append('g')
                .attr("transform", function(d, i) {
                    // position at bottom of graph
                    return 'translate(0, ' + gHeight + ')';
                })
            // Create text elements
            yRule.append("text")
                .attr("x", function (d, i) {
                    return x(i)
                })
                .attr('y', 10)
                .attr("dy", ".0em")
                .attr('dx', (x.rangeBand()/2))
                .attr('text-anchor', 'middle')
                .attr('style', 'font-size: 10pt; fill: #BBB;')
                .text(function (d, i) {
                    // json api will return title for rules
                    return xMax[i]
                })

            // create and assign data to plot lines
            var plotLines = svg.append('g')
                .attr('class','plotLines')
                .attr('transform', 'translate('+left+', '+top+')')
            var plot = plotLines.selectAll('.plot')
                .data(data)
            // Draw line for plot
            .enter().append('line')
                .attr('x1', ( x(0) + (x.rangeBand()/2) ))
                .attr('y1', greyY[0])
                .attr('x2', function (d, i) {
                    return x(0) + (x.rangeBand()/2)
                })
                .attr('y2', function (d, i) {
                    return greyY[0]
                })
                .attr('style', function (d, i) {
                    return 'stroke: #C00; stroke-width: 2; stroke-opacity: 0.6;'
                })
                .attr('class', function (d, i) {
                    if(lastLine == i) {
                        return 'show'
                    } else {
                        return 'hide'
                    }
                })
                .attr('index', function (d, i) {
                    return i
                })
            .transition()
            .delay(500)
            .duration(500)
                .attr('x2', function (d, i) {
                    if(lastLine == i) {
                        var a                = d.lines.progress[1][0]
                        return x(a) + (x.rangeBand()/2)
                    }
                    return x(0) + (x.rangeBand()/2)
                })
                .attr('y2', function (d, i) {
                    if(lastLine == i) {
                        var a                = d.lines.progress[1][1]
                        return y(a)
                    }
                    return greyY[0]
                })

            // create and assign data to plot lines
            var deltaLines = svg.append('g')
                .attr('class','plotLines')
                .attr('transform', 'translate('+left+', '+top+')')
            var delta = plotLines.selectAll('.delta')
                .data(data)
            // Draw line for plot
            .enter().append('line')
                .attr('x1', ( x(0) + (x.rangeBand()/2) ))
                .attr('y1', greyY[0]+greyH[0])
                .attr('x2', function (d, i) {
                    return x(0) + (x.rangeBand()/2)
                })
                .attr('y2', function (d, i) {
                    return greyY[0]+greyH[0]
                })
                .attr('style', function (d, i) {
                    return 'stroke: #00C; stroke-width: 2; stroke-opacity: 0.6;'
                })
                .attr('class', function (d, i) {
                    if(lastLine == i) {
                        return 'show'
                    } else {
                        return 'hide'
                    }
                })
                .attr('index', function (d, i) {
                    return i
                })
            .transition()
            .delay(500)
            .duration(500)
                .attr('x2', function (d, i) {
                    if(lastLine == i) {
                        var a                = d.lines.change[1][0]
                        return x(a) + (x.rangeBand()/2)
                    }
                    return x(0) + (x.rangeBand()/2)
                })
                .attr('y2', function (d, i) {
                    if(lastLine == i) {
                        var a                = d.lines.change[1][1]
                        return y(a)
                    }
                    return greyY[0]+greyH[0]
                })

            function redraw(lines) {
                var line = d3.selectAll(lines)
                .transition()
                .duration(200)
                    .attr('x2', function (d, i) {
                        if(d.lines && i <= lastLine) {
                            var a                = d.lines.change[1][0]
                            return x(a) + (x.rangeBand()/2)
                        }
                        return x(0) + (x.rangeBand()/2)
                    })
                    .attr('y2', function (d, i) {
                        if(d.lines && i <= lastLine) {
                            var a                = d.lines.change[1][1]
                            return y(a)
                        }
                        return greyY[0]
                    })
                return line
            }
            function resetLine(line, y) {
                var line = d3.selectAll(line)
                    .attr('x2', function (d, i) {
                        return x(0) + (x.rangeBand()/2)
                    })
                    .attr('y2', function (d, i) {
                        return y
                    })
                return line
            }
            $('.hide').hide()
            $('.bar').mouseover(function() {
                var a                = $(this).attr('index')
                var b                = $('line[index="'+a+'"]')

                redraw('line[index="'+a+'"]')

                b.show()
                $('.show').hide()
            })
            $('.bar').mouseout(function() {
                var a                = $(this).attr('index')
                var b                = $('line[index="'+a+'"]')
                var c                = b.get(0)
                var d                = b.get(1)
                console.log(c)
                console.log(d)
                var f = resetLine(c, greyY[0])
                var e = resetLine(b, greyY[0]+greyH[0])
                console.log(f)
                console.log(e)

                b.hide()
                $('.show').show()
            })

        }

    </script>
</body>
</html>
